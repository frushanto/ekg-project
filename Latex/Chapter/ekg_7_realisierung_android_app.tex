%EKG-7 Android-App

\subsection{Android-App}
2.4 Android Applikation
Dieses Unterkapitel behandelt den Entwurf und die Entwicklung der Home-EKG Android App zur Darstellung eines EKG Signals unter Verwendung der Bluetooth 2.0 Technologie. Die Kommunikation mit einer Datenbank ermöglicht es der App in Echtzeit Patientendaten zu speichern, sowie Authentifizierungsabfragen durchzuführen. Das Projekt wurde hauptsächlich mit der objektorientierten Programmiersprache Java realisiert. 

\subsubsection{Aktivitäten}
\begin{wrapfigure}[11]{R}{0.35\textwidth}
\vspace{-25pt}
\includegraphics[width=0.35\textwidth]{app_activity.png}
\caption{Activity Lifecycle}
\end{wrapfigure} 
Jede Activity Klasse stellt eine Bildschirm Seite (Login Screen, Register Screen, Home Screen, etc.) der App dar, mit welcher der User interagieren und somit Befehle an das Betriebssystem weitergeben kann. Beim Start einer neuen Aktivität wird eine Instanz der zugrunde liegenden Java Klasse erzeugt und der zugehörige Lebenszyklus gestartet.
Um zwischen den drei Hauptzuständen
\begin{itemize}
\item[•] Aktivität läuft im Vordergrund und hat Fokus
\item[•] Aktivität läuft im Hintergrund
\item[•] Aktivität wurde gestoppt
\end{itemize}
zu wechseln, bietet die Activity Klasse außerdem einen Satz von sechs Callback an, die bei Übergängen von verschiedenen Phasen des Lebenszyklus aufgerufen werden. Durch Verwendung der onCreate() Methode können so zum Beispiel Buttons oder Textfelder initialisiert werden.
Die Home-EKG App besteht insgesamt aus sieben Aktivitäten, welche im Folgenden einzeln vorgestellt werden.

\paragraph{Login und Registrierung Aktivität}
\begin{figure} [!h]
	\begin{center}
		\includegraphics[width=150pt] {app_login.png}
		\hspace{1.5 cm}
		\includegraphics[width=150pt] {app_register.png}
	\end{center}
	\caption{Startseite des EKG-Gerätes}
	\label{fig_Matlab EKG Startseite} 
\end{figure}
Die Login Aktivität stellt den Einstieg des Benutzers in die App dar. Grundlegend werden drei Login Varianten angeboten, wobei der Benutzer nur bei der Methode über E-Mail einen neuen Account anlegen muss, bevor er die App verwenden kann. Die Implementierung der Services von Facebook und Google erlauben es dem Benutzer sich über bereits bestehende Accounts anzumelden, ohne eine erneute Registrierung vornehmen zu müssen.
Außerdem besteht die Möglichkeit durch setzten eines Hakens im Feld „Remember me“ die Daten für zukünftige Anmeldeversuche lokal in einem privaten SharedPreferences Objekt zu speichern, um beim nächsten Start der App den Login Screen zu überspringen und direkt zur Main Aktivität weitergeleitet zu werden. 
Bei Betätigung des Login Buttons wird eine Verbindung zum Server der Datenbank aufgebaut und die in den zwei „TextInput“-Feldern eingegebenen Zeichen an Firebase geschickt. Bei erfolgreichem Abgleich werden die Benutzerdaten vom Server heruntergeladen und der User zum Main Screen weitergeleitet.
Durch einen Klick auf „Register Now“ oder „Plus“ wird eine neue Registrierungs-Aktivität gestartet (siehe Bild 2). Die Felder Name, Password und E-Mail sind verpflichtend auszufüllen. Durch Versenden einer Bestätigung-Mail wird die Validität der Adresse überprüft und der Account erst nach erfolgreicher Bestätigung erstellt.

\paragraph{Home Aktivität}
\begin{figure} [!h]
	\begin{center}
		\includegraphics[width=150pt] {app_profile.png}
		\hspace{1.5 cm}
		\includegraphics[width=150pt] {app_scan.png}
	\end{center}
	\caption{Startseite des EKG-Gerätes}
	\label{fig_Matlab EKG Startseite} 
\end{figure}
Die Home Aktivität stellt dem Benutzer eine Schnittstelle zum Datenbank Server bereit, um seine Daten erstmalig hochzuladen und zu einem späterem Zeitpunkt aktualisieren zu können. Wird zum Beispiel das Gewicht verändert und eine Update Anfrage an Firebase geschickt, wird auch nur dieser Child Node der Benutzer Referenz aktualisiert und nicht das ganze Profil erneut hochgeladen. Durch einen implementierten onDataChange() Listener werden serverseitige Änderungen auch direkt in Echtzeit auf der Home Aktivität aktualisiert, ohne dabei eine ständige Verbindung halten zu müssen.
Die folgenden Attribute sind personalisierbar: Mail, Geschlecht, Geburtsdatum, Größe, Gewicht, Wohnort und Versicherung. Durch Drücken auf das Stift-Symbol unterhalb des Profilbildes, wird ein Action Intent generiert, der die auf dem Smartphone als standesmäßige eingestellte Galerie öffnet und den Benutzer ein personalisiertes Profilbild auswählen lässt. Im onActivityResult() Callback wird dem Foto eine URI zugeordnet und in den Firebase Seicher hochgeladen. Bei einem Login über ein anderes Gerät wird nun auch das neue Profilbild angezeigt und lokal im Speicher hinterlegt, um den Internetdatenverbrauch minimal zu halten.
Über das Dropdown Menu in der oberen rechten Ecke kann der Benutzer einen Logout Dialog starten, wobei auch die Shared Preferences Variable der Auto Login Checkbox zurückgesetzt wird. Der Button „Connect to EKG“ leitet den Benutzer zur Signal Aktivität weiter.

\paragraph{Signal  und Scanner Aktivität}
\begin{figure} [!h]
	\begin{center}
		\includegraphics[width=\textwidth] {app_signal.png}
	\end{center}
	\caption{Startseite des EKG-Gerätes}
	\label{fig_Matlab EKG Startseite} 
\end{figure}
Die Signal Aktivität stellt die Hauptfunktionalität, das Anzeigen eines Echtzeit EKG Signals, der App bereit. Durch Drücken auf den „Connect“ Button wird der Benutzer zur Scanner Aktivität weitergeleitet und aufgefordert Bluetooth zu aktivieren, falls dies nicht bereits geschehen ist.
Um nach Bluetooth Geräten in der Umgebung scannen zu dürfen, muss der Benutzer der App erst die Berechtigung zur Standortfreigabe erteilen, da andere Geräte dadurch auf den Ort des Geräts schließen können.
Ein Klick auf „Start Scanning“ ruft unter anderem die startDiscovery() Methode des BluetoothAdapter Objekts auf. Sobald ein Gerät gefunden wurde wird es mit Namen und zugehöriger Mac-Adresse in ein ListView Layout eingefügt und im internen Gerätespeicher ein Abgleich gestartet, ob dieses Gerät bereits gepaired ist.
Durch Auswahl des EKG7-Geräts versucht die Home EKG App eine Verbindung zu Gerät herzustellen und gibt bei Erfolg eine Toast Nachricht aus. Die App versucht die Verbindung nun solange aufrecht zu erhalten, bis diese geschlossen wird oder der „Disconnect“ Button in  der Signal Aktivität gedrückt wird.



